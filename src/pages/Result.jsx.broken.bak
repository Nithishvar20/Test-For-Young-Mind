import React, { useEffect, useState, useRef } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import { useLang } from '../state/LangContext'

const resultStyles = {
  modalCard: { background: 'linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02))', borderRadius:20, padding:28, boxShadow:'0 30px 80px rgba(0,0,0,0.6)' },
  quoteBox: { background:'linear-gradient(90deg,#6b21a8,#4c1d95)', color:'#fff', padding:'18px 24px', borderRadius:12, boxShadow:'0 12px 30px rgba(76,29,149,0.25)', fontSize:18 },
  puzzleWrap: { background:'linear-gradient(180deg,#0f1724,#111827)', borderRadius:12, padding:20, boxShadow:'0 24px 80px rgba(2,6,23,0.6)'}
}

function generateWordSearch(words, size=12){
  const grid = Array.from({length:size}, ()=> Array.from({length:size}, ()=> null))
  const placed = []
  const rand = (n)=> Math.floor(Math.random()*n)
  for(const w of words){
    const word = w.toUpperCase();
    let placedFlag = false;
    for(let attempt=0; attempt<200 && !placedFlag; attempt++){
      const dir = Math.random() < 0.5 ? 'H' : 'V';
      const len = word.length;
      if(dir==='H'){
        const row = rand(size);
        const col = rand(size - len + 1);
        let ok = true;
        for(let i=0;i<len;i++){
          const c=grid[row][col+i];
          if(c && c !== word[i]){ ok=false; break; }
        }
        if(!ok) continue;
        for(let i=0;i<len;i++) grid[row][col+i]=word[i];
        placed.push({word, dir, row, col, len});
        placedFlag = true;
      } else {
        const row = rand(size - len + 1);
        const col = rand(size);
        let ok = true;
        for(let i=0;i<len;i++){
          const c=grid[row+i][col];
          if(c && c !== word[i]){ ok=false; break; }
        }
        if(!ok) continue;
        for(let i=0;i<len;i++) grid[row+i][col]=word[i];
        placed.push({word, dir, row, col, len});
        placedFlag = true;
      }
    }
  }
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  for(let r=0;r<size;r++) for(let c=0;c<size;c++) if(!grid[r][c]) grid[r][c]=letters.charAt(Math.floor(Math.random()*letters.length));
  return {grid, placed};
}

export default function Result(){
  const { t, toggle, lang } = useLang()
  const nav = useNavigate()
  const { score: scoreParam } = useParams()
  const [score, setScore] = useState( parseInt(scoreParam || sessionStorage.getItem('quiz_score') || '0', 10) )
  const [showModal, setShowModal] = useState(true)
  
  // final score (actual) used by Result modal; ensures setActual exists for init effects
  const [actual, setActual] = useState(() => {
    // prefer route param -> sessionStorage -> 0
    const p = typeof scoreParam !== 'undefined' ? parseInt(scoreParam, 10) : NaN;
    if (!Number.isNaN(p)) return p;
    try { const s = sessionStorage.getItem('quiz_score'); if (s !== null) { const st = parseInt(s,10); if(!Number.isNaN(st)) return st; } } catch(e) {}
    return 0;
  });
const [showQuote, setShowQuote] = useState(true) // show quote popup first
  const [showGame, setShowGame] = useState(false)
  const [isPerfect, setIsPerfect] = useState(false)
  const [puzzle, setPuzzle] = useState(null)
  const [found, setFound] = useState([])
  const [selectedCells, setSelectedCells] = useState([])
  const pointer = useRef({down:false, start:null})
  const [gameTime, setGameTime] = useState(30)
  const gameTimerRef = useRef(null)
  const [gameActive, setGameActive] = useState(false)

  // --- helper: start the 30s word search game ---
  function startGame(){
    if(!puzzle){
      const sampleWords = ['STAR','PLANET','OCEAN','MATH','SCIENCE','HAPPY','LEARN','BRAIN','ENERGY','LIGHT'];
      const chosen = [];
      while(chosen.length < 6){
        const w = sampleWords[Math.floor(Math.random()*sampleWords.length)];
        if(!chosen.includes(w)) chosen.push(w);
      }
      setPuzzle(generateWordSearch(chosen, 12));
      setFound([]);
      setSelectedCells([]);
    }
    setShowGame(false);
    setShowQuote(false);
    setShowModal(true);
    setGameTime(30);
    setGameActive(false);
  }

  // --- run countdown only when showGame is true ---
  useEffect(()=>{
    if(!showGame){
      if(gameTimerRef.current){ clearInterval(gameTimerRef.current); gameTimerRef.current=null; }
      return;
    }
    if(gameTimerRef.current) return;
    gameTimerRef.current = setInterval(()=>{
      setGameTime(t=>{
        if(t<=1){
          clearInterval(gameTimerRef.current); gameTimerRef.current=null;
          setGameActive(false);
          return 0;
        }
        return t-1;
      });
    },1000);
    return ()=>{ if(gameTimerRef.current){ clearInterval(gameTimerRef.current); gameTimerRef.current=null; } };
  },[showGame]);


  // --- Robust init on mount: ensure we show result modal and pick score ---
  
useEffect(()=>{
    // determine final score from params or sessionStorage
    let final = null;
    try{
      const fromStorage = sessionStorage.getItem('quiz_score');
      if(fromStorage !== null) final = parseInt(fromStorage);
    }catch(e){}
    // prefer URL param if present
    const urlScore = parseInt(new URLSearchParams(window.location.search).get('score') || '');
    if(!Number.isNaN(urlScore)) final = urlScore;
    if(final === null || Number.isNaN(final)) final = 0;
    setActual(final);
    const isPerfectNow = final >= 10;
    setIsPerfect(isPerfectNow);
    // For perfect score: show the interactive puzzle first for 30s, then show the result modal
    if(isPerfectNow){
      setShowModal(false);
      setShowQuote(false);
      setShowGame(true);
      const sampleWords = ['LEARN','STUDY','BOOK','TEACH','MATH','SCIENCE','EXAM','CLASS','SCHOOL','KNOWLEDGE','BRAIN','STUDYHARD','GROW'];
      const chosen = [];
      while(chosen.length<6){
        const w = sampleWords[Math.floor(Math.random()*sampleWords.length)];
        if(!chosen.includes(w)) chosen.push(w);
      }
      setPuzzle(generateWordSearch(chosen, 12));
      setFound([]); setSelectedCells([]);
      // start 30s countdown for the interactive bonus puzzle
      setGameTime(30); setGameActive(true);
      if(gameTimerRef.current) clearInterval(gameTimerRef.current);
      gameTimerRef.current = setInterval(()=> setGameTime(t=>{
        if(t<=1){
          if(gameTimerRef.current){ clearInterval(gameTimerRef.current); gameTimerRef.current=null; }
          setGameActive(false);
          setShowGame(false);
          // show final modal and quote after puzzle time ends
          setShowModal(true);
          setShowQuote(true);
          return 0;
        }
        return t-1;
      }), 1000);
    } else {
      // Non-perfect: show result modal immediately
      setShowModal(true);
      setShowQuote(true);
      setShowGame(false);
    }
  },[])




  const quotes = {
    perfect: [
      {en: "Perfect! You're unstoppable üåü", ta: "‡Æö‡Æø‡Æ±‡Æ™‡Øç‡Æ™‡ØÅ! ‡Æâ‡Æ©‡Øç‡Æ©‡Øà ‡Æé‡Æµ‡Æ∞‡Ææ‡Æ≤‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§ ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Ææ‡Æ§‡ØÅ üåü"},
      {en: "A shining star in learning ‚ú®", ta: "‡Æï‡Æ±‡Øç‡Æ±‡Æ≤‡Æø‡Æ≤‡Øç ‡Æí‡Æ∞‡ØÅ ‡Æú‡Øä‡Æ≤‡Æø‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ÆÆ‡Øç ‚ú®"},
      {en: "Flawless performance ‚Äî well done!", ta: "‡Æ§‡Øã‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Ææ‡Æµ‡ØÄ‚Äî ‡Æ®‡Æ©‡Øç‡Æ±‡ØÅ ‡Æ™‡Ææ!"}
    ],
    excellent: [
      {en: "Excellent! Knowledge is your power üíØ", ta: "‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ! ‡ÆÖ‡Æ±‡Æø‡Æµ‡Øá ‡Æâ‡Æ©‡Øç ‡Æö‡Æï‡Øç‡Æ§‡Æø üíØ"},
      {en: "Great work, keep pushing üöÄ", ta: "‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æµ‡Øá‡Æ≤‡Øà, ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÅ ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Øá‡Æ±‡ØÅ üöÄ"}
    ],
    good: [
      {en: "Good effort ‚Äî keep practicing üìö", ta: "‡Æ®‡Æ≤‡Øç‡Æ≤ ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø ‚Äî ‡Æ™‡ÆØ‡Æø‡Æ±‡Øç‡Æö‡Æø ‡Æ§‡Øä‡Æü‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç üìö"},
      {en: "Practice makes progress", ta: "‡Æ™‡ÆØ‡Æø‡Æ±‡Øç‡Æö‡Æø ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Øá‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç ‡Æ§‡Æ∞‡ØÅ‡ÆÆ‡Øç"}
    ],
    support: [
      {en: "Don't give up ‚Äî try again üí™", ta: "‡Æï‡Øà‡Æµ‡Æø‡Æü‡Ææ‡Æ§‡Øá ‚Äî ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø ‡Æö‡ØÜ‡ÆØ‡Øç üí™"},
      {en: "Every expert was once a beginner üå±", ta: "‡Æí‡Æµ‡Øç‡Æµ‡Øä‡Æ∞‡ØÅ ‡Æµ‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æ®‡Æ∞‡ØÅ‡ÆÆ‡Øç ‡Æí‡Æ∞‡ØÅ‡ÆÆ‡ØÅ‡Æ±‡Øà ‡Æ§‡Øä‡Æü‡Æï‡Øç‡Æï‡Æ®‡Æø‡Æ≤‡Øà‡ÆØ‡Æø‡Æ≤‡Øç‡Æ§‡Ææ‡Æ©‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ∞‡Øç üå±"}
    ]
  }

  useEffect(() => {
    if (score >= 10) {
      const sampleWords = ['LEARN','STUDY','BOOK','TEACH','MATH','SCIENCE','EXAM','CLASS','SCHOOL','KNOWLEDGE'];
      const chosen = [];
      while (chosen.length < 6) {
        const w = sampleWords[Math.floor(Math.random() * sampleWords.length)];
        if (!chosen.includes(w)) chosen.push(w);
      }
      setPuzzle(generateWordSearch(chosen, 12));
      setFound([]);
      setSelectedCells([]);
      setShowGame(true);   // Show game immediately
      setGameTime(30);     // Start countdown
      setGameActive(true);
      if (gameTimerRef.current) clearInterval(gameTimerRef.current);
      gameTimerRef.current = setInterval(() => {
        setGameTime(t => {
          if (t <= 1) {
            clearInterval(gameTimerRef.current);
            setGameActive(false);
            setShowGame(false);   // Hide game after 30s
            return 0;
          }
          return t - 1;
        });
      }, 1000);
    }
    return () => { if (gameTimerRef.current) clearInterval(gameTimerRef.current) }
  }, [score])

  return t-1 }), 1000)
    }
    return ()=>{ if(gameTimerRef.current) clearInterval(gameTimerRef.current) }
  },[score])

  // pointer handlers for selection
  function indexOf(r,c,size){ return r*size + c }
  function startSelect(r,c){ if(!puzzle) return; pointer.current.down = true; pointer.current.start={r,c}; setSelectedCells([indexOf(r,c,puzzle.grid.length)]) }
  function updateSelect(r,c){ if(!pointer.current.down || !puzzle) return; const s = pointer.current.start; if(s.r === r){ const row = s.r; const start = Math.min(s.c, c); const end = Math.max(s.c, c); const cells = []; for(let cc=start; cc<=end; cc++) cells.push(indexOf(row,cc,puzzle.grid.length)); setSelectedCells(cells); } else if(s.c === c){ const col = s.c; const start = Math.min(s.r, r); const end = Math.max(s.r, r); const cells = []; for(let rr=start; rr<=end; rr++) cells.push(indexOf(rr,col,puzzle.grid.length)); setSelectedCells(cells); } else { setSelectedCells([]); } }
  function endSelect(){ pointer.current.down = false; if(!puzzle) return; if(selectedCells.length===0) return; const size = puzzle.grid.length; const coords = selectedCells.map(i=> [Math.floor(i/size), i%size]); const letters = coords.map(([rr,cc])=> puzzle.grid[rr][cc]).join(''); const rev = letters.split('').reverse().join(''); let matched = null; for(const p of puzzle.placed){ if(found.includes(p.word)) continue; if(p.word === letters || p.word === rev){ matched = p.word; break; } } if(matched){ setFound(f=> [...f, matched]); setSelectedCells([]); } else { setSelectedCells([]); } }

  function pickQuote(score){
    if(score>=10) return quotes.perfect[Math.floor(Math.random()*quotes.perfect.length)]
    if(score>=8) return quotes.excellent[Math.floor(Math.random()*quotes.excellent.length)]
    if(score>=5) return quotes.good[Math.floor(Math.random()*quotes.good.length)]
    return quotes.support[Math.floor(Math.random()*quotes.support.length)]
  }

  const isPerfect = score>=10
  const quote = pickQuote(score)

  return (
    <div style={{minHeight:'100vh'}}>
      <div style={{padding:28}}>
        <div style={{marginBottom:12}}><button className="btn" onClick={() => { try{ setShowModal(false); setShowGame(false);}catch(e){}; nav("/") }}>‚Üê</button></div>
        <h2 style={{color:'#fff', marginBottom:8}}>Test for Young-Mind</h2>
      </div>

      
{ isPerfect && showGame && (
  <div style={resultStyles.puzzleWrap} className='puzzle-card'>

                  <div style={{position:'absolute', right:18, top:12, background:'#111', color:'#fff', padding:'6px 12px', borderRadius:8, boxShadow:'0 6px 18px rgba(0,0,0,0.4)'}}>Time: {gameTime}s</div>
                  <div style={{position:'absolute', right:18, top:12, background:'#111', color:'#fff', padding:'6px 12px', borderRadius:8, boxShadow:'0 6px 18px rgba(0,0,0,0.4)'}}>Time: {gameTime}s</div>
                  <div style={{flex:1, overflow:'auto', padding:8}}>
                    { puzzle ? (
                      <div onMouseLeave={()=> setSelectedCells([])} style={{userSelect:'none'}}>
                        <div style={{display:'flex', justifyContent:'center', marginBottom:12}}>
                          <div style={{display:'grid', gridTemplateColumns:`repeat(${puzzle.grid.length}, 2rem)`, gap:8}}>
                            {puzzle.grid.flat().map((ch, idx)=>{
                              const r = Math.floor(idx/puzzle.grid.length), c = idx%puzzle.grid.length;
                              const isSelected = selectedCells.includes(idx);
                              let partOfFound = false;
                              for(const p of puzzle.placed){
                                if(found.includes(p.word)){
                                  const {row,col,len,dir} = p;
                                  if(dir==='H' && r===row && c>=col && c<col+len) partOfFound = true;
                                  if(dir==='V' && c===col && r>=row && r<row+len) partOfFound = true;
                                }
                              }
                              const cellStyle = {
        width: 40, height: 40,
        display:'flex', alignItems:'center', justifyContent:'center',
        borderRadius:12,
        background: isSelected
          ? 'linear-gradient(135deg,#ffecd2,#fcb69f)'
          : partOfFound
          ? 'linear-gradient(135deg,#89f7fe,#66a6ff)'
          : 'rgba(255,255,255,0.08)',
        color: partOfFound || isSelected ? '#111' : '#fafafa',
        fontWeight:900,
        fontSize:18,
        transition:'all 0.3s ease',
        boxShadow: isSelected
          ? '0 8px 20px rgba(255,138,0,0.5)'
          : partOfFound
          ? '0 8px 20px rgba(102,166,255,0.5)'
          : '0 4px 10px rgba(0,0,0,0.25)',
        transform: isSelected ? 'scale(1.1)' : partOfFound ? 'scale(1.05)' : 'scale(1)'
      };
      if(partOfFound) cellStyle.transform = 'scale(1.06)'
                              if(partOfFound) cellStyle.boxShadow = '0 18px 40px rgba(124,58,237,0.32)'
                              return <div key={idx} data-idx={idx} onMouseDown={()=> { if(!gameActive) return; startSelect(r,c);} } onMouseEnter={()=> { if(!gameActive) return; updateSelect(r,c);} } onMouseUp={()=> { if(!gameActive) return; endSelect(); }} style={cellStyle}>{ch}</div>
                            })}
                          </div>
                        </div>
                        <div style={{marginTop:10, display:'flex', gap:12, flexWrap:'wrap'}}>
                          {puzzle.placed.map(p=> <div key={p.word} style={{opacity: found.includes(p.word)?0.95:1, background: found.includes(p.word)? 'linear-gradient(90deg,#7c3aed,#4f46e5)' : 'rgba(255,255,255,0.06)', padding:'8px 14px', borderRadius:999, color: found.includes(p.word)? '#fff' : '#e6e6ea', fontWeight:700, transform: found.includes(p.word)? 'scale(1.06)' : 'scale(1)', transition:'transform 0.35s ease, background 0.4s'}}>{p.word}</div>)}
                        </div>
                      </div>
                    ) : <div>Loading game...</div> }
                  </div>

                  <div style={{display:'flex', justifyContent:'space-between', marginTop:12}}>
                    <div style={{display:'flex', gap:12}}>
                      <button className="btn" onClick={() => { try{ setShowModal(false); setShowGame(false);}catch(e){}; nav("/") }}>{t.home || 'Home'}</button>
                    </div>
                    <div style={{alignSelf:'center'}}><small style={{color:'#333'}}>Find the words ‚Äî click / drag horizontally or vertically</small></div>
                  </div>
                
  </div>
)}

            <style>{`
              @keyframes floaty { 0% { transform: translateY(0px);} 50% { transform: translateY(-6px);} 100% { transform: translateY(0px);} }
              .puzzle-card { transition: transform 0.35s ease, box-shadow 0.35s ease; border-radius:12px; padding:14px; }
              .puzzle-card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 20px 60px rgba(0,0,0,0.45); }
              .puzzle-cell { width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; user-select:none; font-weight:600; }
              .puzzle-cell.selected { background: linear-gradient(90deg,#7c3aed,#4f46e5); color:#fff; transform: scale(1.06); }
              .puzzle-cell.found { background: linear-gradient(90deg,#06b6d4,#0ea5a4); color:#061826; }
              .puzzle-words { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:12px; }
              .puzzle-word { padding:6px 10px; border-radius:999px; background: linear-gradient(90deg,#fde68a,#f97316); color:#111; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.25); animation: floaty 3s ease-in-out infinite; }
              .timer-badge { position:absolute; right:18px; top:12px; background:rgba(0,0,0,0.6); color:#fff; padding:6px 12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.4); font-weight:700; }
            `}</style>

{ showModal && (
        <div style={{position:'fixed', left:0, top:0, right:0, bottom:0, display:'flex', alignItems:'center', justifyContent:'center', zIndex:420}}>
          <div style={{width: isPerfect ? '80%' : '60%', maxWidth:isPerfect?900:800, display:'flex', flexDirection:'column', alignItems:'center'}}>


            {!isPerfect && (
              <div>
                <h3 style={{fontSize:28, color:'#fff', marginBottom:8}}>{t.result || 'Result'}</h3>
                <p style={{color:'#ddd'}}>{t.youScored || 'You scored'} {score}/10</p>
                <p style={{color:'#fff', marginTop:12, fontSize:18}}>{quote.en} <span style={{opacity:0.8}}> / </span> <span style={{fontSize:16, color:'#ddd'}}>{quote.ta}</span></p>
                <div style={{marginTop:18, display:'flex', gap:12}}>
                  <button className="btn" onClick={() => { try{ setShowModal(false); setShowGame(false);}catch(e){}; nav("/") }}>{t.home || 'Home'}</button>
                </div>
              </div>
            )}

            { isPerfect && showGame && (
              <div style={{display:'flex', flexDirection:'column', alignItems:'center', gap:12}}>
                <h2 style={{color:'#fff', marginBottom:6}}>Perfect! 10/10 üéâ</h2>
                <p style={{color:'#ddd', marginBottom:8, fontSize:18}}>{quote.en} <span style={{opacity:0.8}}> / </span> <span style={{fontSize:16, color:'#ddd'}}>{quote.ta}</span></p>

                {score === 10 ? null : (
)
}

              </div>
            )}
          </div>
        </div>
      )}

      { isPerfect && gameTime===0 && (
        <div style={{position:'fixed', left:0, right:0, top:0, bottom:0, display:'flex', alignItems:'center', justifyContent:'center', zIndex:450}}>
          <div style={{background:'rgba(0,0,0,0.7)', color:'#fff', padding:28, borderRadius:12}}>
            <h2>Time's up!</h2>
            <p style={{marginTop:8}}>Great job ‚Äî you scored 10/10. Hope you enjoyed the mini-game!</p>
            <div style={{marginTop:12, display:'flex', gap:12, justifyContent:'center'}}>
              <button className="btn" onClick={() => { try{ setShowModal(false); setShowGame(false);}catch(e){}; nav("/") }}>{t.home || 'Home'}</button>
            </div>
          </div>
        </div>
      )}

      <div style={{height:120}}></div>
    </div>
  )
}